<div class="container-fluid mt-4">
  <!-- ENCABEZADO -->
  <div class="d-flex justify-content-between align-items-center mb-4 flex-wrap">
    <h1 class="display-6 fw-semibold">Secrets Dashboard</h1>
    <div class="d-flex gap-2 flex-wrap">
      <button class="btn btn-success" (click)="crearSecreto()">+ New Secret</button>
    </div>
  </div>

  <div *ngIf="loading" class="text-center my-4">
    <div class="spinner-border spinner-azul" role="status" aria-hidden="true"></div>
  </div>

  <!-- TABLA -->
  <div class="card shadow-sm rounded-3" *ngIf="!loading">
    <div class="card-body p-0">
      <table class="table table-hover table-striped mb-0 align-middle" style="table-layout: fixed; width: 100%;">
        <thead class="table-azul">
          <tr>
            <th style="width: 16%;">Name</th>
            <th class="d-none d-md-table-cell" style="width: 16%;">Subtitle</th>
            <th class="d-none d-lg-table-cell" style="width: 26%;">Description</th>
            <th style="width: 10%;">Category</th>
            <th style="width: 8%;">Price</th>
            <!--<th style="width: 8%;">Status</th>-->
            <th style="width: 16%;">PDF</th>
            <th style="width: 16%;">Actions</th>
          </tr>
        </thead>
        <tbody>
          <tr *ngFor="let s of secretos | paginate: { id: 'secretos', itemsPerPage: 5, currentPage: paginaActual }">
            <td class="text-truncate" [title]="s.nombre">{{ s.nombre }}</td>
            <td class="d-none d-md-table-cell text-truncate" [title]="s.subtitulo">{{ s.subtitulo }}</td>
            <td class="d-none d-lg-table-cell text-truncate" [title]="s.descripcion">{{ s.descripcion }}</td>
            <td class="text-truncate">{{ s.categoria }}</td>
            <td class="text-nowrap">{{ s.precio | currency:'EUR' }}</td>
            <!--<td>
              <span [class]="'badge ' + (s.estado ? 'bg-success' : 'bg-danger')">
                {{ s.estado ? 'Active' : 'Inactive' }}
              </span>
            </td>-->
            <td>
              <ng-container *ngIf="s.id; else noPdf">
                <a
                  class="btn btn-outline-secondary btn-sm"
                  [href]="secretoService.getPdfUrl(s.id!)"
                  target="_blank"
                  rel="noopener noreferrer">
                  View PDF
                </a>
              </ng-container>
              <ng-template #noPdf>
                <span class="text-muted">—</span>
              </ng-template>
            </td>
            <td>
              <div class="d-flex flex-column flex-md-row gap-2">
                <button class="btn btn-primary btn-sm" (click)="editarSecreto(s)">Edit</button>
                <button class="btn btn-danger btn-sm" (click)="eliminarSecreto(s.id)">Delete</button>
              </div>
            </td>
          </tr>
          <tr *ngIf="(secretos || []).length === 0">
            <td colspan="7" class="text-center text-muted py-3">No secrets yet.</td>
          </tr>
        </tbody>
      </table>
    </div>
  </div>

  <!-- CONTROLES -->
  <div class="d-flex justify-content-between align-items-center mt-3 flex-wrap mb-5">
    <button class="btn btn-outline-secondary" (click)="exportarCSV()">Export CSV</button>
    <pagination-controls
      id="secretos"
      previousLabel="Previous"
      nextLabel="Next"
      (pageChange)="paginaActual = $event">
    </pagination-controls>
  </div>
</div>

<!-- MODAL -->
<div class="modal fade show d-block" tabindex="-1" *ngIf="secretoEditando">
  <div class="modal-dialog modal-lg">
    <div class="modal-content shadow-lg">
      <div class="modal-header bg-azul text-white">
        <h5 class="modal-title">{{ esNuevo ? 'Create Secret' : 'Edit Secret' }}</h5>
        <button type="button" class="btn-close btn-close-white" (click)="cancelarEdicion()"></button>
      </div>

      <div class="modal-body">
        <form (ngSubmit)="guardarCambios()" #secretoForm="ngForm" novalidate>
          <div class="row g-3">
            <div class="col-md-6">
              <label class="form-label">Name</label>
              <input
                type="text"
                class="form-control"
                name="nombre"
                [(ngModel)]="secretoEditando!.nombre"
                required />
            </div>

            <div class="col-md-6">
              <label class="form-label">Subtitle</label>
              <input
                type="text"
                class="form-control"
                name="subtitulo"
                [(ngModel)]="secretoEditando!.subtitulo"
                required />
            </div>

            <div class="col-12">
              <label class="form-label">Description</label>
              <textarea
                class="form-control"
                name="descripcion"
                rows="3"
                [(ngModel)]="secretoEditando!.descripcion"
                required></textarea>
            </div>

            <div class="col-md-6">
              <label class="form-label">Category</label>
              <input
                type="text"
                class="form-control"
                name="categoria"
                [(ngModel)]="secretoEditando!.categoria"
                required />
            </div>

            <div class="col-md-3">
              <label class="form-label">Price (€)</label>
              <input
                type="number"
                class="form-control"
                name="precio"
                [(ngModel)]="secretoEditando!.precio"
                min="0.01"
                step="0.01"
                required />
            </div>

            <!-- PDF -->
            <div class="col-12">
              <label class="form-label">Secret PDF</label>

              <div class="d-flex flex-wrap align-items-center gap-2">
                <label class="btn btn-sm btn-outline-primary mb-0">
                  Select PDF
                  <input
                  type="file"
                  class="d-none"
                  accept="application/pdf"
                  (change)="onSeleccionarPdf($event)">
                </label>

                <button
                  type="button"
                  class="btn btn-sm btn-outline-danger"
                  (click)="eliminarPdf()"
                  [disabled]="!pdfFile && !pdfPreviewName && esNuevo">
                  Delete
                </button>

                <button
                  type="button"
                  class="btn btn-sm btn-outline-secondary"
                  *ngIf="!esNuevo"
                  (click)="restaurarPdf()">
                  Restore
                </button>

                <span class="text-muted" *ngIf="pdfPreviewName">Selected: {{ pdfPreviewName }}</span>
                <span class="badge bg-danger" *ngIf="pdfMarkedForDelete">To delete</span>
              </div>

              <small class="text-muted d-block mt-1">
                You can upload a new PDF, delete it, or restore the one stored on the server (when editing).
              </small>
            </div>

            <!-- SLOTS DE IMAGEN -->
            <div class="col-12">
              <label class="form-label">Images (up to 5)</label>

              <div class="row g-3">
                <div class="col-6 col-md-4 col-lg-2" *ngFor="let s of slots">
                  <div class="border rounded p-2 text-center position-relative">

                    <img *ngIf="s.previewUrl"
                         [src]="s.previewUrl"
                         alt="preview"
                         style="width:100%; height:100px; object-fit:cover;"
                         class="rounded">

                    <div *ngIf="!s.previewUrl"
                         class="d-flex align-items-center justify-content-center"
                         style="width:100%; height:100px; background:#f6f6f6; border-radius:6px;">
                      <small class="text-muted">Slot {{ s.slot }}</small>
                    </div>

                    <div class="mt-2 d-flex flex-column gap-1">
                      <label class="btn btn-sm btn-outline-primary mb-0">
                        Replace
                      <input
                        type="file"
                        class="d-none"
                        accept="image/webp"
                        (change)="onSeleccionarArchivo($event, s)">
                      </label>

                      <button
                        type="button"
                        class="btn btn-sm btn-outline-danger"
                        (click)="eliminarSlot(s)"
                        [disabled]="esNuevo && !s.previewUrl && !s.file">
                        Delete
                      </button>

                      <button
                        type="button"
                        class="btn btn-sm btn-outline-secondary"
                        *ngIf="!esNuevo"
                        (click)="restaurarSlot(s)">
                        Restore
                      </button>
                    </div>

                    <span *ngIf="s.markedForDelete" class="badge bg-danger position-absolute top-0 start-0 m-1">To delete</span>
                  </div>
                </div>
              </div>

              <small class="text-muted d-block mt-2">
                Tip: “Replace” sube una nueva imagen para ese slot. “Delete” vacía el slot y lo marca para borrado; “Restore” (solo en edición) vuelve a la imagen guardada en el servidor.
                ({{ selectedSlotsCount() }}/5 seleccionadas)
              </small>
            </div>

            <div class="col-12 d-flex justify-content-end gap-2 mt-3">
              <button type="button" class="btn btn-secondary" (click)="cancelarEdicion()">Cancel</button>
              <button type="submit" class="btn bg-azul text-white" [disabled]="secretoForm.invalid">Save</button>
            </div>
          </div>
        </form>
      </div>

    </div>
  </div>
</div>
<div class="modal-backdrop fade show" *ngIf="secretoEditando"></div>

<!-- ============================== -->
<!-- SECRETS PURCHASES DASHBOARD   -->
<!-- ============================== -->
<div class="mt-5">
  <div class="d-flex justify-content-between align-items-center mb-4 flex-wrap">
    <h1 class="display-6 fw-semibold">Secret Purchases Dashboard</h1>
  </div>

  <div *ngIf="loadingCompras" class="text-center my-4">
    <div class="spinner-border spinner-azul" role="status" aria-hidden="true"></div>
  </div>

  <div class="card shadow-sm rounded-3" *ngIf="!loadingCompras">
    <div class="card-body p-0">
      <div class="table-responsive">
        <table class="table table-hover table-striped mb-0 align-middle" style="table-layout: fixed; width: 100%;">
          <thead class="table-azul">
            <tr>
              <th style="width: 12%;">Date</th>
              <th style="width: 14%;">Client ID</th>
              <th style="width: 14%;">Secret ID</th>
              <th style="width: 14%;">Purchase ID</th>
              <th style="width: 46%;">Actions</th>
            </tr>
          </thead>

          <tbody>
            <tr *ngFor="let c of comprasSecretos | paginate: { id: 'comprasSecretos', itemsPerPage: 5, currentPage: paginaActualCompras }">
              <td class="text-nowrap">
                {{ c.fechaCompra | date:'yyyy-MM-dd' }}
              </td>
              <td>{{ c.clienteId }}</td>
              <td>{{ c.secretoId }}</td>
              <td>{{ c.compraId }}</td>
              <td>
                <div class="d-flex flex-column flex-md-row gap-2">
                  <!-- Botones opcionales a futuro -->
                  <!-- <button class="btn btn-primary btn-sm">Ver detalle</button> -->
                  <!-- <button class="btn btn-danger btn-sm" (click)="eliminarCompraSecreto(c.id)">Eliminar</button> -->
                </div>
              </td>
            </tr>

            <tr *ngIf="(comprasSecretos || []).length === 0">
              <td colspan="5" class="text-center text-muted py-3">No secret purchases yet.</td>
            </tr>
          </tbody>
        </table>
      </div>
    </div>
  </div>

  <!-- CONTROLES ABAJO -->
  <div class="d-flex justify-content-between align-items-center mt-3 flex-wrap mb-5">
    <button class="btn btn-outline-secondary" (click)="exportarCSVComprasSecretos()">Export Purchases CSV</button>

    <pagination-controls
      id="comprasSecretos"
      previousLabel="Previous"
      nextLabel="Next"
      (pageChange)="paginaActualCompras = $event">
    </pagination-controls>
  </div>
</div>


<app-feedback-modal
  *ngIf="mostrarFeedback"
  [title]="feedbackTitulo"
  [message]="feedbackMensaje"
  [status]="feedbackTipo"
  (closed)="cerrarFeedback()"
></app-feedback-modal>