<div class="container-fluid mt-4">
  <!-- ENCABEZADO -->
  <div class="d-flex justify-content-between align-items-center mb-4 flex-wrap">
    <h1 class="display-6 fw-semibold">Gift Card Dashboard</h1>
    <div class="d-flex gap-2 flex-wrap">
      <button class="btn btn-success" (click)="crearTarjeta()">+ New Gift Card</button>
    </div>
  </div>

  <div *ngIf="loading" class="text-center my-4">
    <div class="spinner-border spinner-azul" role="status" aria-hidden="true"></div>
  </div>

  <!-- TABLA EN UNA CARD -->
  <div class="card shadow-sm rounded-3" *ngIf="!loading">
    <div class="card-body p-0">
      <div class="table-responsive">
        <table class="table table-hover table-striped mb-0 align-middle" style="table-layout: fixed; width: 100%;">
          <thead class="table-azul">
            <tr>
              <th style="width: 32%;">Name</th>
              <th style="width: 12%;">Price</th>
              <th style="width: 20%;">Actions</th>
            </tr>
          </thead>
          <tbody>
            <tr *ngFor="let tarjeta of tarjetas | paginate: { id: 'tarjetas', itemsPerPage: 5, currentPage: paginaActual }">
              <td>
                <span class="d-inline-block w-100 text-truncate" [title]="tarjeta.nombre">
                  {{ tarjeta.nombre }}
                </span>
              </td>

              <td class="text-nowrap">{{ tarjeta.precio | currency:'EUR' }}</td>

              <td>
                <div class="d-flex flex-column flex-md-row gap-2">
                  <button class="btn btn-primary btn-sm" (click)="editarTarjeta(tarjeta)">Edit</button>
                  <button class="btn btn-danger btn-sm" (click)="eliminarTarjeta(tarjeta.id!)">Delete</button>
                </div>
              </td>
            </tr>
          </tbody>
        </table>
      </div>
    </div>
  </div>

  <!-- CONTROLES DE ABAJO -->
  <div class="d-flex justify-content-between align-items-center mt-3 flex-wrap mb-5">
    <button class="btn btn-outline-secondary" (click)="exportarCSV()">Export CSV</button>
    <pagination-controls
      id="tarjetas"
      previousLabel="Previous"
      nextLabel="Next"
      (pageChange)="paginaActual = $event">
    </pagination-controls>
  </div>
</div>

<!-- MODAL -->
<div class="modal fade show d-block" tabindex="-1" *ngIf="tarjetaEditando">
  <div class="modal-dialog modal-lg">
    <div class="modal-content shadow-lg">
      <div class="modal-header bg-azul text-white">
        <h5 class="modal-title">{{ esNueva ? 'Create Gift Card' : 'Edit Gift Card' }}</h5>
        <button type="button" class="btn-close btn-close-white" (click)="cancelarEdicion()"></button>
      </div>

      <div class="modal-body">
        <form (ngSubmit)="guardarCambios()" #tarjetaForm="ngForm" novalidate>
          <div class="row g-3">

            <div class="col-md-6">
              <label class="form-label">Name</label>
              <input
                type="text"
                class="form-control"
                name="nombre"
                [(ngModel)]="tarjetaEditando.nombre"
                required
              />
            </div>

            <div class="col-md-6">
              <label class="form-label">Price (€)</label>
              <input
                type="number"
                class="form-control"
                name="precio"
                [(ngModel)]="tarjetaEditando.precio"
                min="0.01"
                step="0.01"
                required
              />
            </div>

            <!-- SLOT ÚNICO DE IMAGEN -->
            <div class="col-12">
              <label class="form-label">Image</label>

              <div class="row g-3">
                <div class="col-6 col-md-4 col-lg-3">
                  <div class="border rounded p-2 text-center position-relative">

                    <!-- Preview -->
                    <img *ngIf="imgSlot.previewUrl"
                         [src]="imgSlot.previewUrl"
                         alt="preview"
                         style="width:100%; height:120px; object-fit:cover;"
                         class="rounded">

                    <!-- Placeholder -->
                    <div *ngIf="!imgSlot.previewUrl"
                         class="d-flex align-items-center justify-content-center"
                         style="width:100%; height:120px; background:#f6f6f6; border-radius:6px;">
                      <small class="text-muted">No image</small>
                    </div>

                    <!-- Controles -->
                    <div class="mt-2 d-flex flex-column gap-1">
                      <label class="btn btn-sm btn-outline-primary mb-0">
                        Replace
                        <input
                          type="file"
                          class="d-none"
                          accept="image/webp"
                          (change)="onSeleccionarArchivo($event)">
                      </label>

                      <button
                        type="button"
                        class="btn btn-sm btn-outline-danger"
                        (click)="eliminarImagen()"
                        [disabled]="esNueva && !imgSlot.previewUrl && !imgSlot.file">
                        Delete
                      </button>

                      <button
                        type="button"
                        class="btn btn-sm btn-outline-secondary"
                        *ngIf="!esNueva"
                        (click)="restaurarImagen()">
                        Restore
                      </button>
                    </div>

                    <span *ngIf="imgSlot.markedForDelete"
                          class="badge bg-danger position-absolute top-0 start-0 m-1">To delete</span>
                  </div>
                </div>
              </div>

              <small class="text-muted d-block mt-2">
                Tip: “Replace” sube una nueva imagen. “Delete” la elimina (se marca para borrado);
                “Restore” (solo en edición) vuelve a la imagen guardada en el servidor.
              </small>
            </div>
            <!-- FIN SLOT -->

          </div>

          <div class="d-flex justify-content-end gap-2 mt-3">
            <button type="button" class="btn btn-secondary" (click)="cancelarEdicion()">Cancel</button>
            <button type="submit" class="btn btn-success" [disabled]="tarjetaForm.invalid">Save</button>
          </div>
        </form>
      </div>

    </div>
  </div>
</div>
<div class="modal-backdrop fade show" *ngIf="tarjetaEditando"></div>

<!-- ============================== -->
<!-- GIFT CARD PURCHASES DASHBOARD -->
<!-- ============================== -->
<div class="mt-5">
  <div class="d-flex justify-content-between align-items-center mb-4 flex-wrap">
    <h1 class="display-6 fw-semibold">Gift Card Purchases Dashboard</h1>
  </div>

  <div *ngIf="loadingCompras" class="text-center my-4">
    <div class="spinner-border spinner-azul" role="status" aria-hidden="true"></div>
  </div>

  <!-- TABLA COMPRAS -->
  <div class="card shadow-sm rounded-3" *ngIf="!loadingCompras">
    <div class="card-body p-0">
      <div class="table-responsive">
        <table class="table table-hover table-striped mb-0 align-middle" style="table-layout: fixed; width: 100%;">
          <thead class="table-azul">
            <tr>
              <th style="width: 15%;">Code</th>
              <th style="width: 20%;">Recipient</th>
              <th style="width: 10%;">Redeemed</th>
              <th style="width: 15%;">Purchase Date</th>
              <th style="width: 15%;">Expiration</th>
              <th style="width: 25%;">Actions</th>
            </tr>
          </thead>

          <tbody>
            <tr *ngFor="let compra of tarjetasCompra | paginate: { id: 'compras', itemsPerPage: 5, currentPage: paginaActualCompras }">
              <td>
                <span class="d-inline-block w-100 text-truncate" [title]="compra.codigo">
                  {{ compra.codigo }}
                </span>
              </td>

              <td>
                <span class="d-inline-block w-100 text-truncate" [title]="compra.destinatario">
                  {{ compra.destinatario || '—' }}
                </span>
              </td>

              <td class="text-nowrap">
                <span
                  class="badge"
                  [ngClass]="compra.canjeada ? 'bg-success' : 'bg-secondary'">
                  {{ compra.canjeada ? 'Yes' : 'No' }}
                </span>
              </td>

              <td class="text-nowrap">{{ compra.fechaCompra | date:'yyyy-MM-dd' }}</td>
              <td class="text-nowrap">{{ compra.fechaCaducidad | date:'yyyy-MM-dd' }}</td>

              <td>
                <div class="d-flex flex-column flex-md-row gap-2">
                  <button
                    class="btn btn-primary btn-sm"
                    (click)="marcarCanjeada(compra)"
                    [disabled]="compra.canjeada">
                    Mark as Redeemed
                  </button>
                  <button
                    class="btn btn-danger btn-sm"
                    (click)="eliminarCompra(compra.id!)">
                    Delete
                  </button>
                </div>
              </td>
            </tr>

            <tr *ngIf="(tarjetasCompra || []).length === 0">
              <td colspan="6" class="text-center text-muted py-3">
                No gift card purchases yet.
              </td>
            </tr>
          </tbody>
        </table>
      </div>
    </div>
  </div>

  <!-- CONTROLES DE ABAJO -->
  <div class="d-flex justify-content-between align-items-center mt-3 flex-wrap mb-5">
    <button class="btn btn-outline-secondary" (click)="exportarCSVCompras()">Export Purchases CSV</button>

    <pagination-controls
      id="compras"
      previousLabel="Previous"
      nextLabel="Next"
      (pageChange)="paginaActualCompras = $event">
    </pagination-controls>
  </div>
</div>

<app-feedback-modal
 *ngIf="mostrarFeedback"
 [title]="feedbackTitulo"
 [message]="feedbackMensaje"
 [status]="feedbackTipo"
 (closed)="cerrarFeedback()"
></app-feedback-modal>

