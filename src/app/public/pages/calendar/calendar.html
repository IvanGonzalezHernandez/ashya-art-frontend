<section class="py-4 bg-beige calendar-section">
  <div class="container">

    <!-- Header -->
    <div class="d-flex flex-column flex-md-row justify-content-between align-items-start align-items-md-center gap-3 mb-3"
         appRevealAnimate="animate__fadeInUp"
         [delay]="'0s'">
      <h2 class="m-0 fw-bold" [style.color]="brandColor">{{ current | date:'MMMM yyyy' }}</h2>
      <div class="d-flex gap-2">
        <button class="btn btn-sm btn-outline-secondary" (click)="prevMonth()">&laquo;</button>
        <button class="btn btn-sm btn-outline-secondary" (click)="thisMonth()">Today</button>
        <button class="btn btn-sm btn-outline-secondary" (click)="nextMonth()">&raquo;</button>
      </div>
    </div>

    <!-- Loading / Error -->
    <div *ngIf="loading" class="text-center my-4">
      <div class="spinner-border spinner-azul" role="status" aria-hidden="true"></div>
    </div>

    <div *ngIf="!loading && error"
         class="alert alert-danger"
         appRevealAnimate="animate__fadeInUp"
         [delay]="'0.05s'">
      {{ error }}
    </div>

    <!-- Weekdays -->
    <div class="row g-2 text-center small fw-semibold text-muted mb-1"
         appRevealAnimate="animate__fadeInUp"
         [delay]="'0.1s'">
      <div class="col" *ngFor="let w of ['Mon','Tue','Wed','Thu','Fri','Sat','Sun']">{{ w }}</div>
    </div>

    <!-- Calendar grid -->
    <div class="row g-2"
         appRevealAnimate="animate__fadeInUp"
         [delay]="'0.15s'">
      <div class="col-12">
        <div class="grid calendar-grid">
          <div class="cell"
               *ngFor="let week of weeks; let r = index"
               [attr.data-row]="r">
            <div class="day"
                 *ngFor="let cell of week"
                 [class.outside]="!cell.inCurrentMonth"
                 [class.has-sessions]="cell.sessions.length"
                 [class.selected]="selectedKey === cell.key"
                 [class.past]="isPast(cell)"
                 (click)="!isPast(cell) && onSelectDay(cell)">
              <div class="day-number">{{ cell.date.getDate() }}</div>

              <!-- Indicador de sesiones -->
              <div class="sessions-pill"
                   *ngIf="cell.sessions.length"
                   [attr.aria-label]="cell.sessions.length + ' classes'">
                {{ cell.sessions.length }} class{{ cell.sessions.length > 1 ? 'es' : '' }}
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>

  </div>
</section>

<!-- === MODAL  === -->
<div class="modal fade"
     id="calendar_modalFechasDisponibles"
     tabindex="-1"
     aria-labelledby="calendar_modalFechasDisponiblesLabel"
     aria-hidden="true">
  <div class="modal-dialog modal-lg modal-dialog-centered">
    <div class="modal-content shadow-lg">
      <div class="modal-header bg-azul text-white">
        <h5 class="modal-title" id="calendar_modalFechasDisponiblesLabel">
          Available Dates
          <span *ngIf="selectedDate">&nbsp;— {{ selectedDate | date:'EEEE, dd/MM/yyyy' }}</span>
        </h5>
        <button type="button"
                class="btn-close btn-close-white"
                data-bs-dismiss="modal"
                aria-label="Close"></button>
      </div>

      <div class="modal-body">
        <div *ngIf="cursosFecha.length > 0; else noFechas">

          <!-- Lista de cursos del día -->
          <div *ngFor="let fecha of cursosFecha" class="card mb-3 calendar-modal-card">
            <div class="card-body calendar-modal-row">

              <!-- IZQ: imagen + info -->
              <div class="calendar-modal-left">
                <img *ngIf="getImg(fecha)"
                     [src]="getImg(fecha)"
                     alt="Course"
                     class="calendar-modal-img">

                <div class="calendar-modal-info">

                  <!-- Nombre (gris/italic si pasada o sin plazas) -->
                  <h5 class="card-title mb-1 calendar-modal-title"
                      [ngStyle]="(isPastDate(fecha.fecha) || fecha.plazasDisponibles === 0) ? {
                        'opacity': '0.45',
                        'font-style': 'italic'
                      } : {}">
                    {{ getNombre(fecha) }}
                  </h5>

                  <!-- Subtítulo -->
                  <div class="text-muted small calendar-modal-subtitle"
                       *ngIf="getSubtitulo(fecha)"
                       [ngStyle]="(isPastDate(fecha.fecha) || fecha.plazasDisponibles === 0) ? {'opacity': '0.45'} : {}">
                    {{ getSubtitulo(fecha) }}
                  </div>

                  <!-- Fecha · horario · seats (RESPONSIVE, sin nowrap) -->
                  <div class="small mt-1 calendar-modal-meta"
                       [ngStyle]="(isPastDate(fecha.fecha) || fecha.plazasDisponibles === 0) ? {'opacity': '0.45'} : {}">

                    <span class="meta-item">{{ fecha.fecha | date:'dd/MM/yyyy' }}</span>

                    <span class="meta-sep d-none d-md-inline">·</span>

                    <span class="meta-item">{{ fecha.horaInicio }} - {{ fecha.horaFin }}</span>

                    <span class="meta-sep d-none d-md-inline">·</span>

                    <span class="meta-item">Seats: <strong>{{ fecha.plazasDisponibles }}</strong></span>
                  </div>
                </div>
              </div>

              <!-- DCHA: precio + cantidad + botón -->
              <div class="calendar-modal-actions">
                <div class="fw-semibold calendar-modal-price" *ngIf="getPrecio(fecha) !== null">
                  €{{ getPrecio(fecha) | number:'1.2-2' }}
                </div>

                <label for="plazasSelect{{fecha.id}}" class="visually-hidden">Quantity</label>

                <select id="plazasSelect{{fecha.id}}"
                        class="form-select form-select-sm calendar-modal-qty"
                        [(ngModel)]="cantidades[fecha.id]"
                        name="cantidad{{fecha.id}}"
                        [disabled]="fecha.plazasDisponibles === 0 || isPastDate(fecha.fecha)">

                  <!-- Si NO se puede reservar: solo 0 -->
                  <option *ngIf="fecha.plazasDisponibles === 0 || isPastDate(fecha.fecha)" value="0">0</option>

                  <!-- Si se puede reservar: 1..N -->
                  <ng-container *ngIf="fecha.plazasDisponibles > 0 && !isPastDate(fecha.fecha)">
                    <option *ngFor="let _ of [].constructor(fecha.plazasDisponibles); let i = index"
                            [value]="i + 1">
                      {{ i + 1 }}
                    </option>
                  </ng-container>
                </select>

                <!-- Botón solo si hay plazas y fecha futura -->
                <button type="button"
                        class="btn bg-azul text-white btn-sm calendar-modal-btn"
                        *ngIf="fecha.plazasDisponibles > 0 && !isPastDate(fecha.fecha)"
                        (click)="agregarCursoAlCarrito(fecha)">
                  Add to cart
                </button>
              </div>

            </div>
          </div>

        </div>

        <!-- Si no hay cursos -->
        <ng-template #noFechas>
          <p class="mb-0">There are no available dates for this day.</p>
        </ng-template>
      </div>

      <div class="modal-footer">
        <button class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
      </div>
    </div>
  </div>
</div>
